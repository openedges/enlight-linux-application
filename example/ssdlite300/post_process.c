
/*
    Openedges Enlight post process main
*/

#include "stdint.h"
#include "npu_data_type.h"
#include "oacts_tbl.h"
#include "quantized_prior_box.h"

typedef enum {
   LOGISTIC_NONE    = 0,
   LOGISTIC_SIGMOID = 1,
   LOGISTIC_SOFTMAX = 2,
} logistic_t;

typedef enum {
   NMS_DEFAULT = 0,
   NMS_FAST    = 1,
} nms_t;

uint32_t ssd_scr_logistic_table[256] = {
     //score_scl 3
     //softmax
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001, 
     0x00000001, 0x00000001, 0x00000001, 0x00000001, 0x00000001, 0x00000001, 0x00000001, 0x00000002, 0x00000002, 0x00000002, 0x00000002, 0x00000003, 0x00000003, 0x00000003, 0x00000004, 0x00000004, 
     0x00000005, 0x00000005, 0x00000006, 0x00000007, 0x00000008, 0x00000009, 0x0000000a, 0x0000000b, 0x0000000d, 0x0000000e, 0x00000010, 0x00000013, 0x00000015, 0x00000018, 0x0000001b, 0x0000001f, 
     0x00000023, 0x00000027, 0x0000002c, 0x00000032, 0x00000039, 0x00000041, 0x00000049, 0x00000053, 0x0000005e, 0x0000006b, 0x00000079, 0x00000089, 0x0000009b, 0x000000b0, 0x000000c7, 0x000000e2, 
     0x00000100, 0x00000122, 0x00000149, 0x00000174, 0x000001a6, 0x000001de, 0x0000021e, 0x00000266, 0x000002b8, 0x00000315, 0x0000037e, 0x000003f4, 0x0000047b, 0x00000514, 0x000005c1, 0x00000685, 
     0x00000764, 0x0000085f, 0x0000097d, 0x00000ac0, 0x00000c2f, 0x00000dce, 0x00000fa5, 0x000011ba, 0x00001416, 0x000016c3, 0x000019ca, 0x00001d39, 0x0000211e, 0x00002586, 0x00002a85, 0x0000302f, 
     0x00003699, 0x00003dde, 0x0000461b, 0x00004f71, 0x00005a04, 0x00006601, 0x00007396, 0x000082f9, 0x0000946a, 0x0000a82d, 0x0000be91, 0x0000d7f1, 0x0000f4b1, 0x00011546, 0x00013a31, 0x00016406, 
     0x0001936e, 0x0001c925, 0x00020603, 0x00024afc, 0x00029924, 0x0002f1b4, 0x0003560f, 0x0003c7c6, 0x000448a2, 0x0004daa6, 0x0005801b, 0x00063b98, 0x0007100b, 0x000800c8, 0x00091193, 0x000a46b0, 
     0x000ba4f5, 0x000d31de, 0x000ef3a0, 0x0010f145, 0x001332c5, 0x0015c12a, 0x0018a6b0, 0x001beef2, 0x001fa715, 0x0023ddff, 0x0028a491, 0x002e0deb, 0x00342fba, 0x003b228e, 0x0043023b, 0x004bee4a, 
     0x00560a77, 0x00617f41, 0x006e7a8b, 0x007d3052, 0x008ddb81, 0x00a0bedb, 0x00b62607, 0x00ce66bf, 0x00e9e224, 0x0109064b, 0x012c4feb, 0x01544c5d, 0x01819bc5, 0x01b4f3a0, 0x01ef218f, 0x02310e99, 
     0x027bc2cb, 0x02d06957, 0x0330554a, 0x039d06d3, 0x04183149, 0x04a3c1fb, 0x0541e7e5, 0x05f51c73, 0x06c02d64, 0x07a6480d, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 
     0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 0x07ffffff, 
};

uint32_t ssd_loc_exp_table[256] = {
     //loc_scl 6
     0x00000023, 0x00000023, 0x00000024, 0x00000024, 0x00000025, 0x00000025, 0x00000026, 0x00000027, 0x00000027, 0x00000028, 0x00000029, 0x00000029, 0x0000002a, 0x0000002a, 0x0000002b, 0x0000002c, 
     0x0000002c, 0x0000002d, 0x0000002e, 0x0000002f, 0x0000002f, 0x00000030, 0x00000031, 0x00000032, 0x00000032, 0x00000033, 0x00000034, 0x00000035, 0x00000036, 0x00000037, 0x00000037, 0x00000038, 
     0x00000039, 0x0000003a, 0x0000003b, 0x0000003c, 0x0000003d, 0x0000003e, 0x0000003f, 0x00000040, 0x00000041, 0x00000042, 0x00000043, 0x00000044, 0x00000045, 0x00000046, 0x00000047, 0x00000048, 
     0x00000049, 0x0000004b, 0x0000004c, 0x0000004d, 0x0000004e, 0x0000004f, 0x00000051, 0x00000052, 0x00000053, 0x00000054, 0x00000056, 0x00000057, 0x00000058, 0x0000005a, 0x0000005b, 0x0000005d, 
     0x0000005e, 0x00000060, 0x00000061, 0x00000063, 0x00000064, 0x00000066, 0x00000067, 0x00000069, 0x0000006b, 0x0000006c, 0x0000006e, 0x00000070, 0x00000072, 0x00000073, 0x00000075, 0x00000077, 
     0x00000079, 0x0000007b, 0x0000007d, 0x0000007f, 0x00000081, 0x00000083, 0x00000085, 0x00000087, 0x00000089, 0x0000008b, 0x0000008d, 0x00000090, 0x00000092, 0x00000094, 0x00000096, 0x00000099, 
     0x0000009b, 0x0000009e, 0x000000a0, 0x000000a3, 0x000000a5, 0x000000a8, 0x000000ab, 0x000000ad, 0x000000b0, 0x000000b3, 0x000000b6, 0x000000b8, 0x000000bb, 0x000000be, 0x000000c1, 0x000000c4, 
     0x000000c7, 0x000000cb, 0x000000ce, 0x000000d1, 0x000000d4, 0x000000d8, 0x000000db, 0x000000de, 0x000000e2, 0x000000e5, 0x000000e9, 0x000000ed, 0x000000f0, 0x000000f4, 0x000000f8, 0x000000fc, 
     0x00000100, 0x00000104, 0x00000108, 0x0000010c, 0x00000111, 0x00000115, 0x00000119, 0x0000011e, 0x00000122, 0x00000127, 0x0000012b, 0x00000130, 0x00000135, 0x0000013a, 0x0000013f, 0x00000144, 
     0x00000149, 0x0000014e, 0x00000153, 0x00000158, 0x0000015e, 0x00000163, 0x00000169, 0x0000016f, 0x00000174, 0x0000017a, 0x00000180, 0x00000186, 0x0000018d, 0x00000193, 0x00000199, 0x000001a0, 
     0x000001a6, 0x000001ad, 0x000001b3, 0x000001ba, 0x000001c1, 0x000001c8, 0x000001d0, 0x000001d7, 0x000001de, 0x000001e6, 0x000001ed, 0x000001f5, 0x000001fd, 0x00000205, 0x0000020d, 0x00000216, 
     0x0000021e, 0x00000226, 0x0000022f, 0x00000238, 0x00000241, 0x0000024a, 0x00000253, 0x0000025d, 0x00000266, 0x00000270, 0x0000027a, 0x00000284, 0x0000028e, 0x00000298, 0x000002a2, 0x000002ad, 
     0x000002b8, 0x000002c3, 0x000002ce, 0x000002d9, 0x000002e5, 0x000002f0, 0x000002fc, 0x00000308, 0x00000315, 0x00000321, 0x0000032e, 0x0000033a, 0x00000347, 0x00000355, 0x00000362, 0x00000370, 
     0x0000037e, 0x0000038c, 0x0000039a, 0x000003a8, 0x000003b7, 0x000003c6, 0x000003d5, 0x000003e5, 0x000003f4, 0x00000404, 0x00000415, 0x00000425, 0x00000436, 0x00000447, 0x00000458, 0x0000046a, 
     0x0000047b, 0x0000048d, 0x000004a0, 0x000004b2, 0x000004c5, 0x000004d9, 0x000004ec, 0x00000500, 0x00000514, 0x00000529, 0x0000053d, 0x00000552, 0x00000568, 0x0000057e, 0x00000594, 0x000005aa, 
     0x000005c1, 0x000005d8, 0x000005f0, 0x00000608, 0x00000620, 0x00000639, 0x00000652, 0x0000066b, 0x00000685, 0x000006a0, 0x000006ba, 0x000006d5, 0x000006f1, 0x0000070d, 0x00000729, 0x00000746, 
};

void ssd_detector_init(void *base);

void ssd_detector_run(
    uint8_t *prior_box,
    uint8_t *loc_buf_32,
    uint8_t *score_buf_32,
    uint32_t *loc_exp_tbl, uint32_t *score_logistic_tbl,
    int prior_scl, int loc_scl, int score_scl,
    int num_class, int num_box, int img_h, int img_w,
    int th_conf, int th_iou,
    int bg_in_cls, int logistic, int nms_method
);

void run_post_process(void *oact_base, void *work_base)
{
    act_tensor_t *oact_score = &Concat_269;
    act_tensor_t *oact_loc = &Concat_270;

    uint32_t* loc_exp_tbl = ssd_loc_exp_table;
    uint32_t* score_logistic_tbl = ssd_scr_logistic_table;

    uint8_t* oact_base_addr = (uint8_t*)oact_base;
    uint8_t* loc_buf_addr = oact_base_addr + (unsigned long)(oact_loc->buf);
    uint8_t* score_buf_addr = oact_base_addr + (unsigned long)(oact_score->buf);
    uint8_t* prior_box_addr = prior_box;

    int bg_in_class = 1;
    int logistic    = LOGISTIC_SOFTMAX;
    int nms_method  = NMS_DEFAULT;

    int prior_scl   = 8;
    int score_scl   = 3;
    int loc_scl     = 6;
    int num_class   = 21;
    int th_conf     = 128;
    int th_iou      = 128;
    int num_box     = 3000;
    int img_h       = 300;
    int img_w       = 300;

    ssd_detector_init(work_base);

    ssd_detector_run(prior_box_addr, loc_buf_addr, score_buf_addr,
        loc_exp_tbl, score_logistic_tbl,
        prior_scl, loc_scl, score_scl,
        num_class, num_box, img_h, img_w,
        th_conf, th_iou,
        bg_in_class, logistic, nms_method);
}
#ifdef TEST_ON_PC
void get_ssd_network_info(
    uint8_t** prior_box_addr,
    uint32_t** loc_exp_tbl, uint32_t** score_logistic_tbl,
    int *prior_scl, int *loc_scl, int *score_scl,
    int *num_class, int *num_box, int *img_h, int *img_w,
    int *th_conf, int *th_iou,
    int *bg_in_class, int *logistic, int *nms_method)
{
    *prior_box_addr      = prior_box;
    *loc_exp_tbl         = ssd_loc_exp_table;
    *score_logistic_tbl  = ssd_scr_logistic_table;
    *prior_scl           = 8;
    *score_scl           = 3;
    *loc_scl             = 6;
    *num_class           = 21;
    *th_conf             = 128;
    *th_iou              = 128;
    *num_box             = 3000;
    *img_h               = 300;
    *img_w               = 300;
    *bg_in_class         = 1;
    *logistic            = LOGISTIC_SOFTMAX;
    *nms_method          = NMS_DEFAULT;
}
#endif