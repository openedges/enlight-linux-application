
/*
    Openedges Enlight post process main
*/

#include "stdint.h"
#include "npu_data_type.h"
#include "oacts_tbl.h"
#include "quantized_prior_box.h"

typedef enum {
   LOGISTIC_NONE    = 0,
   LOGISTIC_SIGMOID = 1,
   LOGISTIC_SOFTMAX = 2,
} logistic_t;

typedef enum {
   NMS_DEFAULT = 0,
   NMS_FAST    = 1,
} nms_t;

uint32_t ssd_scr_logistic_table[256] = {
     //score_scl 1
     //sigmoid
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
     0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000001, 0x00000002, 0x00000003, 0x00000005, 0x00000008, 0x0000000c, 0x00000013, 0x0000001f, 0x0000002f, 0x00000045, 0x00000061, 
     0x00000080, 0x0000009f, 0x000000bb, 0x000000d1, 0x000000e1, 0x000000ed, 0x000000f4, 0x000000f8, 0x000000fb, 0x000000fd, 0x000000fe, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 
     0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 
     0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 
     0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 
     0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 
     0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 
     0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 
     0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 0x000000ff, 
};

uint32_t ssd_loc_exp_table[256] = {
     //loc_scl 7
     0x0000005e, 0x0000005f, 0x00000060, 0x00000060, 0x00000061, 0x00000062, 0x00000063, 0x00000063, 0x00000064, 0x00000065, 0x00000066, 0x00000067, 0x00000067, 0x00000068, 0x00000069, 0x0000006a, 
     0x0000006b, 0x0000006c, 0x0000006c, 0x0000006d, 0x0000006e, 0x0000006f, 0x00000070, 0x00000071, 0x00000072, 0x00000072, 0x00000073, 0x00000074, 0x00000075, 0x00000076, 0x00000077, 0x00000078, 
     0x00000079, 0x0000007a, 0x0000007b, 0x0000007c, 0x0000007d, 0x0000007e, 0x0000007f, 0x00000080, 0x00000081, 0x00000082, 0x00000083, 0x00000084, 0x00000085, 0x00000086, 0x00000087, 0x00000088, 
     0x00000089, 0x0000008a, 0x0000008b, 0x0000008c, 0x0000008d, 0x0000008e, 0x00000090, 0x00000091, 0x00000092, 0x00000093, 0x00000094, 0x00000095, 0x00000096, 0x00000098, 0x00000099, 0x0000009a, 
     0x0000009b, 0x0000009c, 0x0000009e, 0x0000009f, 0x000000a0, 0x000000a1, 0x000000a3, 0x000000a4, 0x000000a5, 0x000000a7, 0x000000a8, 0x000000a9, 0x000000ab, 0x000000ac, 0x000000ad, 0x000000af, 
     0x000000b0, 0x000000b1, 0x000000b3, 0x000000b4, 0x000000b6, 0x000000b7, 0x000000b8, 0x000000ba, 0x000000bb, 0x000000bd, 0x000000be, 0x000000c0, 0x000000c1, 0x000000c3, 0x000000c4, 0x000000c6, 
     0x000000c7, 0x000000c9, 0x000000cb, 0x000000cc, 0x000000ce, 0x000000cf, 0x000000d1, 0x000000d3, 0x000000d4, 0x000000d6, 0x000000d8, 0x000000d9, 0x000000db, 0x000000dd, 0x000000de, 0x000000e0, 
     0x000000e2, 0x000000e4, 0x000000e5, 0x000000e7, 0x000000e9, 0x000000eb, 0x000000ed, 0x000000ef, 0x000000f0, 0x000000f2, 0x000000f4, 0x000000f6, 0x000000f8, 0x000000fa, 0x000000fc, 0x000000fe, 
     0x00000100, 0x00000102, 0x00000104, 0x00000106, 0x00000108, 0x0000010a, 0x0000010c, 0x0000010e, 0x00000111, 0x00000113, 0x00000115, 0x00000117, 0x00000119, 0x0000011b, 0x0000011e, 0x00000120, 
     0x00000122, 0x00000124, 0x00000127, 0x00000129, 0x0000012b, 0x0000012e, 0x00000130, 0x00000132, 0x00000135, 0x00000137, 0x0000013a, 0x0000013c, 0x0000013f, 0x00000141, 0x00000144, 0x00000146, 
     0x00000149, 0x0000014b, 0x0000014e, 0x00000151, 0x00000153, 0x00000156, 0x00000158, 0x0000015b, 0x0000015e, 0x00000161, 0x00000163, 0x00000166, 0x00000169, 0x0000016c, 0x0000016f, 0x00000172, 
     0x00000174, 0x00000177, 0x0000017a, 0x0000017d, 0x00000180, 0x00000183, 0x00000186, 0x00000189, 0x0000018d, 0x00000190, 0x00000193, 0x00000196, 0x00000199, 0x0000019c, 0x000001a0, 0x000001a3, 
     0x000001a6, 0x000001a9, 0x000001ad, 0x000001b0, 0x000001b3, 0x000001b7, 0x000001ba, 0x000001be, 0x000001c1, 0x000001c5, 0x000001c8, 0x000001cc, 0x000001d0, 0x000001d3, 0x000001d7, 0x000001db, 
     0x000001de, 0x000001e2, 0x000001e6, 0x000001ea, 0x000001ed, 0x000001f1, 0x000001f5, 0x000001f9, 0x000001fd, 0x00000201, 0x00000205, 0x00000209, 0x0000020d, 0x00000211, 0x00000216, 0x0000021a, 
     0x0000021e, 0x00000222, 0x00000226, 0x0000022b, 0x0000022f, 0x00000234, 0x00000238, 0x0000023c, 0x00000241, 0x00000245, 0x0000024a, 0x0000024f, 0x00000253, 0x00000258, 0x0000025d, 0x00000261, 
     0x00000266, 0x0000026b, 0x00000270, 0x00000275, 0x0000027a, 0x0000027f, 0x00000284, 0x00000289, 0x0000028e, 0x00000293, 0x00000298, 0x0000029d, 0x000002a2, 0x000002a8, 0x000002ad, 0x000002b2, 
};

void ssd_detector_init(void *base);

void ssd_detector_run(
    uint8_t *prior_box,
    uint8_t *loc_buf_32,
    uint8_t *score_buf_32,
    uint32_t *loc_exp_tbl, uint32_t *score_logistic_tbl,
    int prior_scl, int loc_scl, int score_scl,
    int num_class, int num_box, int img_h, int img_w,
    int th_conf, int th_iou,
    int bg_in_cls, int logistic, int nms_method
);

void run_post_process(void *oact_base, void *work_base)
{
    act_tensor_t *oact_score = &Concat_878;
    act_tensor_t *oact_loc = &Concat_879;

    uint32_t* loc_exp_tbl = ssd_loc_exp_table;
    uint32_t* score_logistic_tbl = ssd_scr_logistic_table;

    uint8_t* oact_base_addr = (uint8_t*)oact_base;
    uint8_t* loc_buf_addr = oact_base_addr + (unsigned long)(oact_loc->buf);
    uint8_t* score_buf_addr = oact_base_addr + (unsigned long)(oact_score->buf);
    uint8_t* prior_box_addr = prior_box;

    int bg_in_class = 0;
    int logistic    = LOGISTIC_SIGMOID;
    int nms_method  = NMS_DEFAULT;

    int prior_scl   = 8;
    int score_scl   = 1;
    int loc_scl     = 7;
    int num_class   = 20;
    int th_conf     = 128;
    int th_iou      = 128;
    int num_box     = 49104;
    int img_h       = 512;
    int img_w       = 512;

    ssd_detector_init(work_base);

    ssd_detector_run(prior_box_addr, loc_buf_addr, score_buf_addr,
        loc_exp_tbl, score_logistic_tbl,
        prior_scl, loc_scl, score_scl,
        num_class, num_box, img_h, img_w,
        th_conf, th_iou,
        bg_in_class, logistic, nms_method);
}
#ifdef TEST_ON_PC
void get_ssd_network_info(
    uint8_t** prior_box_addr,
    uint32_t** loc_exp_tbl, uint32_t** score_logistic_tbl,
    int *prior_scl, int *loc_scl, int *score_scl,
    int *num_class, int *num_box, int *img_h, int *img_w,
    int *th_conf, int *th_iou,
    int *bg_in_class, int *logistic, int *nms_method)
{
    *prior_box_addr      = prior_box;
    *loc_exp_tbl         = ssd_loc_exp_table;
    *score_logistic_tbl  = ssd_scr_logistic_table;
    *prior_scl           = 8;
    *score_scl           = 1;
    *loc_scl             = 7;
    *num_class           = 20;
    *th_conf             = 128;
    *th_iou              = 128;
    *num_box             = 49104;
    *img_h               = 512;
    *img_w               = 512;
    *bg_in_class         = 0;
    *logistic            = LOGISTIC_SIGMOID;
    *nms_method          = NMS_DEFAULT;
}
#endif